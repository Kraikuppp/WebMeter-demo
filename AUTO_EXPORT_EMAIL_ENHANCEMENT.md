# Auto Export Email Enhancement - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏ô Auto Export

## ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏î‡∏¥‡∏° üîç

### **Auto Export ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Manual Export**:
- **Manual Export**: ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö (PDF/CSV/Image) ‡∏ú‡πà‡∏≤‡∏ô nodemailer
- **Auto Export**: ‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ HTML content ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö
- **‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô**: User ‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Manual Export

## ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç üí°

### **1. ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á sendEmailExport Function** ‚úÖ
```javascript
// Send email export with file attachment (like manual export)
async sendEmailExport(schedule, meterData, dateTimeInfo) {
  try {
    console.log(`üìß Sending email export for schedule ${schedule.id}`);
    console.log(`üìß Export type: ${schedule.export_type}`);
    
    // Get email recipients
    const recipients = await this.getEmailRecipients(schedule.email_list);
    if (recipients.length === 0) {
      console.log(`‚ö†Ô∏è No email recipients found for schedule ${schedule.id}`);
      return { success: false, error: 'No email recipients found' };
    }
    
    // Generate file attachment based on export type
    let attachment = null;
    let filename = '';
    let contentType = '';
    
    if (schedule.export_type === 'pdf') {
      // Generate PDF using the same method as generatePdfContent
      attachment = await this.generatePdfContent(schedule, meterData, dateTimeInfo);
      filename = `export_${new Date().toISOString().split('T')[0].replace(/-/g, '')}.pdf`;
      contentType = 'application/pdf';
      console.log(`üìÑ Generated PDF attachment: ${filename}`);
      
    } else if (schedule.export_type === 'excel') {
      // Generate Excel using the same method as generateExcelContent
      attachment = await this.generateExcelContent(schedule, meterData, dateTimeInfo);
      filename = `export_${new Date().toISOString().split('T')[0].replace(/-/g, '')}.xlsx`;
      contentType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
      console.log(`üìä Generated Excel attachment: ${filename}`);
      
    } else {
      console.log(`‚ùå Unsupported export type: ${schedule.export_type}`);
      return { success: false, error: `Unsupported export type: ${schedule.export_type}` };
    }
    
    // Send emails to all recipients with attachment
    const mailOptions = {
      from: process.env.EMAIL_USER,
      to: recipient.email,
      subject: `WebMeter Auto Export - ${schedule.export_type.toUpperCase()} Report (${new Date().toLocaleDateString('en-GB')})`,
      html: emailContent,
      attachments: [{
        filename: filename,
        content: attachment,
        contentType: contentType
      }]
    };

    await emailTransporter.sendMail(mailOptions);
    
    return { 
      success: successCount > 0, 
      recipients: recipients.length,
      successCount,
      failCount,
      attachment: attachment ? 'Generated' : 'Failed'
    };
  } catch (error) {
    console.error(`‚ùå Error sending email export:`, error);
    throw error;
  }
}
```

### **2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Email Transporter Configuration** ‚úÖ
```javascript
// ‡πÄ‡∏î‡∏¥‡∏°: ‡πÉ‡∏ä‡πâ EMAIL_PASSWORD
const emailTransporter = nodemailer.createTransporter({
  service: 'gmail',
  auth: {
    user: process.env.EMAIL_USER,
    pass: process.env.EMAIL_PASSWORD // ‚ùå ‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô manual export
  }
});

// ‡πÉ‡∏´‡∏°‡πà: ‡πÉ‡∏ä‡πâ EMAIL_APP_PASSWORD ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô manual export
const createEmailTransporter = () => {
  return nodemailer.createTransporter({
    service: 'gmail',
    auth: {
      user: process.env.EMAIL_USER,
      pass: process.env.EMAIL_APP_PASSWORD // ‚úÖ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô manual export
    }
  });
};

const emailTransporter = createEmailTransporter();
```

### **3. ‡πÄ‡∏û‡∏¥‡πà‡∏° Professional Email Template** ‚úÖ
```javascript
const emailContent = `
  <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <h2 style="color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
      WebMeter Auto Export Report
    </h2>
    
    <div style="background-color: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0;">
      <h3 style="color: #374151; margin-top: 0;">Report Details</h3>
      <p><strong>Export Type:</strong> ${schedule.export_type.toUpperCase()}</p>
      <p><strong>Date Range:</strong> ${dateRange}</p>
      <p><strong>Meters:</strong> ${meterNames}</p>
      <p><strong>Generated:</strong> ${new Date().toLocaleString('en-GB')}</p>
    </div>
    
    <p style="color: #6b7280;">
      This is an automated report generated by WebMeter system. 
      Please find the attached ${schedule.export_type.toUpperCase()} file with the detailed data.
    </p>
    
    <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">
    
    <p style="color: #9ca3af; font-size: 12px;">
      WebMeter by Amptron Thailand Co.,Ltd.<br>
      Generated automatically on ${new Date().toLocaleString('en-GB')}
    </p>
  </div>
`;
```

### **4. ‡πÄ‡∏û‡∏¥‡πà‡∏° Error Handling ‡πÅ‡∏•‡∏∞ Success Tracking** ‚úÖ
```javascript
// Send emails to all recipients
let successCount = 0;
let failCount = 0;

for (const recipient of recipients) {
  try {
    await emailTransporter.sendMail(mailOptions);
    console.log(`üìß Email sent successfully to ${recipient.email}`);
    successCount++;
    
  } catch (emailError) {
    console.error(`‚ùå Failed to send email to ${recipient.email}:`, emailError);
    failCount++;
  }
}

console.log(`üìß Email sending completed: ${successCount} success, ${failCount} failed`);
```

## Manual Export Email System üìß

### **Frontend (reportUtils.ts)**:
```typescript
// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á backend API
const requestBody = {
  to_email: user.email,
  to_name: user.username || user.name || user.email,
  subject: `WebMeter Report ${format(new Date(), 'dd/MM/yyyy')}`,
  tableData: filteredData,
  columns: displayColumns,
  meterName: meterName,
  dateRange: dateRange,
  timeRange: timeRange,
  exportType: payload.exportType, // 'pdf', 'csv', 'image', 'text'
  reportTitle: reportTitle,
  customImageData: customImageData
};

const pdfResponse = await fetch('http://localhost:3001/api/email/send-pdf', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(requestBody)
});
```

### **Backend API (server/routes/email.js)**:
```javascript
// POST /api/email/send-pdf - ‡∏™‡πà‡∏á PDF/CSV/Image ‡∏ú‡πà‡∏≤‡∏ô email
router.post('/send-pdf', async (req, res) => {
  const { 
    to_email, to_name, subject, tableData, columns, 
    meterName, dateRange, timeRange, exportType,
    customImageData, reportTitle
  } = req.body;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≤‡∏° exportType
  if (exportType === 'pdf') {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏î‡πâ‡∏ß‡∏¢ jsPDF + autoTable
    const doc = new jsPDF('landscape', 'mm', 'a4');
    // ... PDF generation logic
    attachment = Buffer.from(doc.output('arraybuffer'));
    
  } else if (exportType === 'csv') {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á CSV string
    let csv = 'Title,Meter,Date,Time\n';
    // ... CSV generation logic
    attachment = Buffer.from(csv, 'utf8');
    
  } else if (exportType === 'image') {
    // ‡πÉ‡∏ä‡πâ customImageData ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á canvas image
    if (customImageData) {
      const base64Data = customImageData.replace(/^data:image\/png;base64,/, '');
      attachment = Buffer.from(base64Data, 'base64');
    } else {
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á image ‡∏à‡∏≤‡∏Å canvas
    }
  }

  // ‡∏™‡πà‡∏á email ‡∏î‡πâ‡∏ß‡∏¢ nodemailer
  const transporter = createTransporter();
  await transporter.sendMail({
    from: process.env.EMAIL_USER,
    to: to_email,
    subject: subject,
    html: emailBody,
    attachments: [{ filename, content: attachment, contentType }]
  });
});
```

## ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå üéØ

### **Auto Export ‡πÉ‡∏´‡∏°‡πà** ‚úÖ:
- **‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö**: PDF ‡∏´‡∏£‡∏∑‡∏≠ Excel ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
- **Email Template ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°**: Professional HTML template
- **‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á**: ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å meterListCache
- **Error Handling**: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error ‡πÅ‡∏•‡∏∞ success tracking
- **Environment Variables**: ‡πÉ‡∏ä‡πâ EMAIL_APP_PASSWORD ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô manual export

### **Consistency ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Manual ‡πÅ‡∏•‡∏∞ Auto Export** üîÑ:
- **‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö**: ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
- **Email Configuration**: ‡πÉ‡∏ä‡πâ transporter ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
- **‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå**: Format ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (export_DDMMYYYY.pdf)
- **Content Type**: MIME types ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô

### **‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Auto Export Email** üì§:

#### **1. Schedule ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô**:
- ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
- ‚úÖ ‡πÅ‡∏°‡∏õ meter names ‡∏à‡∏≤‡∏Å meterListCache
- ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF/Excel

#### **2. ‡∏™‡πà‡∏á Email**:
- ‚úÖ ‡∏î‡∏∂‡∏á email recipients ‡∏à‡∏≤‡∏Å database
- ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML email template
- ‚úÖ ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå PDF/Excel
- ‚úÖ ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô nodemailer

#### **3. Error Handling**:
- ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö recipients
- ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ attachment generation errors
- ‚úÖ Track success/fail count
- ‚úÖ Log detailed error messages

## ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö üß™

### **Test Case 1: PDF Auto Export**
- **Input**: Schedule export_type = 'pdf', email_list = [1, 2]
- **Expected**: ‡∏™‡πà‡∏á PDF ‡πÅ‡∏ô‡∏ö‡πÉ‡∏´‡πâ 2 ‡∏Ñ‡∏ô
- **Result**: ‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏û‡∏£‡πâ‡∏≠‡∏° PDF attachment

### **Test Case 2: Excel Auto Export**
- **Input**: Schedule export_type = 'excel', email_list = [3]
- **Expected**: ‡∏™‡πà‡∏á Excel ‡πÅ‡∏ô‡∏ö‡πÉ‡∏´‡πâ 1 ‡∏Ñ‡∏ô
- **Result**: ‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏û‡∏£‡πâ‡∏≠‡∏° Excel attachment

### **Test Case 3: No Recipients**
- **Input**: Schedule email_list = []
- **Expected**: Return error "No email recipients found"
- **Result**: ‚úÖ Handle gracefully

## Debug Information üîç

### **Console Logs ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°**:
```javascript
console.log(`üìß Sending email export for schedule ${schedule.id}`);
console.log(`üìß Export type: ${schedule.export_type}`);
console.log(`üìÑ Generated PDF attachment: ${filename}`);
console.log(`üìä Generated Excel attachment: ${filename}`);
console.log(`üìß Email sent successfully to ${recipient.email}`);
console.log(`üìß Email sending completed: ${successCount} success, ${failCount} failed`);
```

### **Return Values**:
```javascript
return { 
  success: successCount > 0, 
  recipients: recipients.length,
  successCount,
  failCount,
  attachment: attachment ? 'Generated' : 'Failed'
};
```

## ‡∏™‡∏£‡∏∏‡∏õ üéâ

### **‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß**:
- ‚úÖ **Auto Export ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö**: ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Manual Export
- ‚úÖ **Email Configuration**: ‡πÉ‡∏ä‡πâ EMAIL_APP_PASSWORD
- ‚úÖ **Professional Email Template**: HTML template ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
- ‚úÖ **Error Handling**: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error cases ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
- ‚úÖ **Success Tracking**: ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô success/fail
- ‚úÖ **Meter Name Mapping**: ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

### **‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô**:
1. **‡∏™‡∏£‡πâ‡∏≤‡∏á Auto Export Schedule** ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å export_format = 'email'
2. **‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•** ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö PDF/Excel
3. **Recipients ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö** ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Manual Export
4. **‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console** ‡∏î‡∏π success/fail count

### **Expected Results**:
- **PDF Schedule**: ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏° PDF attachment ‚úÖ
- **Excel Schedule**: ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏° Excel attachment ‚úÖ
- **Multiple Recipients**: ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô email_list ‚úÖ
- **Error Cases**: Handle gracefully ‡πÑ‡∏°‡πà crash ‚úÖ

‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ Auto Export ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Manual Export ‡πÅ‡∏•‡πâ‡∏ß! üéØ
